#!/usr/bin/env bash
set -euo pipefail

# === Einstellungen ===
PLACE_NAME="Waldfeucht"
PLACE_LONG="Waldfeucht, Kreis Heinsberg"
LAT="51.07139"
LON="5.98306"
TIMEZONE="Europe/Berlin"
PORT="/dev/ttyUSB0"
CH_INDEX="2"

# === Begr√º√üungen und Abschiede ===
greetings=(
  "Hallo, wie geht‚Äôs?"
  "Guten Tag!"
  "Moin aus der Wetterk√ºche!"
  "Einen sonnigen Tag w√ºnsche ich!"
  "Gr√º√üe vom Wetterdienst!"
  "Hi, Wetter freudig?"
  "Servus vom Wetterteam!"
  "Regenschauer incoming... fast!"
  "Achtung, Wetter nah!"
  "Bereit f√ºr die Wettervorhersage?"
)
farewells=(
  "Bis sp√§ter, Wolkenstreichler!"
  "Tsch√ºss, wetterfest bleiben!"
  "Ciao, Sonne im Herzen!"
  "Bleib trocken!"
  "Gr√º√üe, vom Wetter"
  "Bis zum n√§chsten Wettergru√ü!"
  "Auf Wiederh√∂ren, Regencheck!"
  "Mach‚Äôs gut, Wetterfreund!"
  "Adieu, mit Wind im R√ºcken!"
  "Tschau, wettersicher!"
)

# Zuf√§llige Auswahlfunktion
select_random() {
  local arr=("${!1}")
  local idx=$(( RANDOM % ${#arr[@]} ))
  echo "${arr[$idx]}"
}

# Begr√º√üung
GREETING="$(select_random greetings[@])"

# === Wetterdaten abrufen ===
API="https://api.open-meteo.com/v1/forecast"
DAILY_VARS="weathercode,temperature_2m_max,temperature_2m_min,precipitation_probability_max,wind_speed_10m_max"
JSON="$(curl -sS --fail "$API?latitude=${LAT}&longitude=${LON}&daily=${DAILY_VARS}&timezone=${TIMEZONE}&forecast_days=1")"

WX_CODE=$(jq -r '.daily.weathercode[0]' <<<"$JSON")
TMAX=$(jq -r '.daily.temperature_2m_max[0]' <<<"$JSON")
TMIN=$(jq -r '.daily.temperature_2m_min[0]' <<<"$JSON")
PRCP=$(jq -r '.daily.precipitation_probability_max[0]' <<<"$JSON")
WIND=$(jq -r '.daily.wind_speed_10m_max[0]' <<<"$JSON")

case "$WX_CODE" in
  0)  icon="‚òÄÔ∏è"; text="Sonnig";;
  1|2|3) icon="‚õÖ"; text="Wolkig";;
  45|48) icon="üå´Ô∏è"; text="Nebel";;
  51|53|55) icon="üå¶Ô∏è"; text="Niesel";;
  61|63|65) icon="üåßÔ∏è"; text="Regen";;
  80|81|82) icon="üåßÔ∏è"; text="Schauer";;
  71|73|75|77|85|86) icon="‚ùÑÔ∏è"; text="Schnee";;
  95|96|99) icon="‚õàÔ∏è"; text="Gewitter";;
  *) icon="üå§Ô∏è"; text="Wechselhaft";;
esac

MSG_BODY="$icon $PLACE_LONG: $text. Max ${TMAX}¬∞C / Min ${TMIN}¬∞C, Regenrisiko ${PRCP}%, Wind max ${WIND} km/h."

# Abschied
FAREWELL="$(select_random farewells[@])"

# Gesamt-Nachricht
MSG="$GREETING $MSG_BODY $FAREWELL"

# Sender via Meshtastic
sudo meshtastic --port "$PORT" --ch-index "$CH_INDEX" --sendtext "$MSG"

# Log
echo "$(date +"%F %T") | $MSG" >> "${HOME}/wetter_meshtastic.log"
echo "Gesendet: $MSG"
